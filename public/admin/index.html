<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>

    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Pretendard', 'ui-sans-serif', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Noto Sans KR', 'Apple SD Gothic Neo', 'sans-serif'],
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="/assets/theme.css" />
  </head>
  <body class="font-sans">
    <header class="sticky top-0 z-40 backdrop-blur bg-white/70 border-b border-slate-100">
      <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-2xl bg-slate-900 text-white grid place-items-center shadow-sm">S</div>
          <div>
            <div class="text-sm font-semibold text-slate-900 leading-none">Admin Dashboard</div>
            <div class="text-xs text-slate-500 mt-1" id="adminMeta">ì¸ì¦ í™•ì¸ ì¤‘...</div>
          </div>
        </div>
        <nav class="flex items-center gap-2">
          <a href="/" class="px-3 py-2 rounded-2xl text-sm text-slate-700 hover:bg-slate-100 transition">í•™ìƒ í™”ë©´</a>
          <button id="logoutBtn" class="px-3 py-2 rounded-2xl text-sm text-slate-700 hover:bg-slate-100 transition">ë¡œê·¸ì•„ì›ƒ</button>
        </nav>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-10">
      <section class="float-in">
        <div class="flex items-end justify-between gap-6 flex-wrap">
          <div>
            <h1 class="text-2xl md:text-3xl font-semibold tracking-tight text-slate-900">ê±´ì˜ ê´€ë¦¬</h1>
            <p class="text-slate-600 mt-2">í•™ë…„ í•„í„°/ê²€ìƒ‰ í›„ ë‹µë³€ì„ ì‘ì„±í•˜ë©´ ìƒíƒœê°€ ìë™ìœ¼ë¡œ "ë‹µë³€ì™„ë£Œ"ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.</p>
          </div>
          <div class="flex items-center gap-2 flex-wrap">
            <button id="adminNotifyBtn" class="px-4 py-2.5 rounded-2xl bg-emerald-600 text-white text-sm font-semibold shadow-sm hover:shadow-md transition">
              ğŸ”” ê´€ë¦¬ì ì•Œë¦¼ ì„¤ì •
            </button>
            <input id="q" placeholder="ì œëª©/ë‚´ìš© ê²€ìƒ‰" class="w-56 rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-4 focus:ring-slate-200/60" />
            <select id="status" class="rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-4 focus:ring-slate-200/60">
              <option value="">ì „ì²´ ìƒíƒœ</option>
              <option value="pending">ëŒ€ê¸°ì¤‘</option>
              <option value="answered">ë‹µë³€ì™„ë£Œ</option>
            </select>
            <button id="refreshBtn" class="px-4 py-2.5 rounded-2xl bg-slate-900 text-white text-sm font-semibold shadow-sm hover:shadow-md transition">ì¡°íšŒ</button>
          </div>
        </div>

        <div class="mt-6 rounded-3xl bg-white shadow-md ring-1 ring-slate-200 p-4">
          <div class="text-sm font-semibold text-slate-900">í•™ë…„ í•„í„°</div>
          <div class="mt-3 flex flex-wrap gap-2" id="gradeFilters"></div>
        </div>

        <div id="list" class="mt-8 grid grid-cols-1 gap-6"></div>
      </section>
    </main>

    <script src="/assets/app.js"></script>
    <script>
      const token = localStorage.getItem('admin_token');
      if (!token) location.href = '/admin/login.html';

      // VAPID Public Key
      const VAPID_PUBLIC_KEY = 'BJpbfzPQdhyWeK9lv9Rs6S3bdqYZpgAUqTuw6j0-ME2sxXWM8THv4d1ZCow2BtjPoULAqJb5yy86mPkXly0Fqpc';

      function adminFetch(path, opts = {}) {
        return App.apiFetch(path, {
          ...opts,
          headers: {
            ...(opts.headers || {}),
            Authorization: 'Bearer ' + token,
          }
        });
      }

      // Admin push notification setup
      let swRegistration = null;
      let isPushSubscribed = false;
      
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then((reg) => {
            swRegistration = reg;
            console.log('Service Worker registered for admin');
            
            // Check existing subscription
            reg.pushManager.getSubscription().then((sub) => {
              if (sub) {
                isPushSubscribed = true;
                updateAdminNotifyButton();
              }
            });
          })
          .catch((err) => console.log('SW registration failed:', err));
      }

      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      function arrayBufferToBase64Url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      async function setupAdminPush() {
        if (!swRegistration) {
          App.toast('Browser does not support push notifications', 'error');
          return;
        }
        
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          App.toast('Notification permission required', 'error');
          return;
        }
        
        try {
          const sub = await swRegistration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
          });
          
          await adminFetch('/push/admin/subscribe', {
            method: 'POST',
            body: {
              endpoint: sub.endpoint,
              p256dh: arrayBufferToBase64Url(sub.getKey('p256dh')),
              auth: arrayBufferToBase64Url(sub.getKey('auth'))
            }
          });
          
          isPushSubscribed = true;
          updateAdminNotifyButton();
          App.toast('Admin notification enabled!', 'success');
        } catch (e) {
          console.error('Admin push setup failed:', e);
          App.toast('Failed to enable notifications', 'error');
        }
      }

      function updateAdminNotifyButton() {
        const btn = document.getElementById('adminNotifyBtn');
        if (isPushSubscribed) {
          btn.textContent = 'ğŸ”” ì•Œë¦¼ ì„¤ì • ì™„ë£Œ';
          btn.classList.add('opacity-60');
        } else {
          btn.textContent = 'ğŸ”” ê´€ë¦¬ì ì•Œë¦¼ ì„¤ì •';
        }
      }

      document.getElementById('adminNotifyBtn').addEventListener('click', setupAdminPush);

      const adminMeta = document.getElementById('adminMeta');
      const listEl = document.getElementById('list');
      const gradeFilters = document.getElementById('gradeFilters');
      let selectedGrade = '';

      function fmt(dt) {
        try { return new Date(dt).toLocaleString('ko-KR', { hour12: false }); }
        catch { return String(dt); }
      }

      function badge(status) {
        const cls = status === 'answered'
          ? 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200'
          : 'bg-amber-50 text-amber-700 ring-1 ring-amber-200';
        const label = status === 'answered' ? 'ë‹µë³€ì™„ë£Œ' : 'ëŒ€ê¸°ì¤‘';
        return App.el('span', { class: `px-3 py-1 rounded-full text-xs font-semibold ${cls}` }, [label]);
      }

      function renderGradeFilters() {
        gradeFilters.innerHTML = '';
        const allBtn = App.el('button', {
          type: 'button',
          class: `px-3 py-2 rounded-2xl text-sm font-semibold ring-1 transition ${selectedGrade === '' ? 'bg-slate-900 text-white ring-slate-900' : 'bg-white text-slate-700 ring-slate-200 hover:bg-slate-50'}`,
          onclick: () => { selectedGrade = ''; renderGradeFilters(); load(); },
        }, ['ì „ì²´']);
        gradeFilters.appendChild(allBtn);
        for (let g = 1; g <= 3; g++) {
          const active = String(g) === selectedGrade;
          const btn = App.el('button', {
            type: 'button',
            class: `px-3 py-2 rounded-2xl text-sm font-semibold ring-1 transition ${active ? 'bg-slate-900 text-white ring-slate-900' : 'bg-white text-slate-700 ring-slate-200 hover:bg-slate-50'}`,
            onclick: () => { selectedGrade = String(g); renderGradeFilters(); load(); },
          }, [`${g}í•™ë…„`]);
          gradeFilters.appendChild(btn);
        }
      }

      function itemCard(s) {
        const wrap = App.el('div', { class: 'rounded-3xl bg-white shadow-md ring-1 ring-slate-200 overflow-hidden hover:shadow-lg transition' });
        const head = App.el('div', { class: 'px-6 py-5 border-b border-slate-100 flex items-start justify-between gap-4' }, [
          App.el('div', {}, [
            App.el('div', { class: 'text-sm text-slate-500' }, [`#${s.id} Â· ${s.grade}í•™ë…„ Â· ${fmt(s.created_at)}`]),
            App.el('div', { class: 'text-lg font-semibold text-slate-900 mt-1' }, [s.title]),
          ]),
          badge(s.status),
        ]);
        const body = App.el('div', { class: 'px-6 py-5 text-sm text-slate-700 leading-relaxed whitespace-pre-wrap' }, [s.content]);

        const answerBox = App.el('div', { class: 'px-6 py-5 bg-slate-50 border-t border-slate-100' });
        answerBox.appendChild(App.el('div', { class: 'text-sm font-semibold text-slate-900' }, ['ë‹µë³€ ì‘ì„±']));
        answerBox.appendChild(App.el('div', { class: 'text-xs text-slate-500 mt-1' }, ['ì €ì¥í•˜ë©´ ìë™ìœ¼ë¡œ ìƒíƒœê°€ ë‹µë³€ì™„ë£Œë¡œ ë°”ë€ë‹ˆë‹¤.']));

        const ta = App.el('textarea', {
          class: 'mt-3 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-4 focus:ring-slate-200/60',
          rows: '5',
          placeholder: 'ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...',
        }, [s.answer || '']);

        const saveBtn = App.el('button', {
          class: 'mt-3 px-5 py-3 rounded-2xl bg-slate-900 text-white text-sm font-semibold shadow-sm hover:shadow-md transition',
        }, ['ë‹µë³€ ì €ì¥']);
        saveBtn.addEventListener('click', async () => {
          saveBtn.disabled = true;
          saveBtn.classList.add('opacity-60');
          try {
            await adminFetch(`/admin/suggestions/${s.id}/answer`, { method: 'PATCH', body: { answer: ta.value } });
            App.toast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            await load();
          } catch (err) {
            App.toast(err.message || 'ì €ì¥ ì‹¤íŒ¨', 'error');
          } finally {
            saveBtn.disabled = false;
            saveBtn.classList.remove('opacity-60');
          }
        });

        answerBox.append(ta, saveBtn);

        wrap.append(head, body, answerBox);
        return wrap;
      }

      async function load() {
        listEl.innerHTML = App.el('div', { class: 'text-sm text-slate-500' }, ['ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...']).outerHTML;
        const params = new URLSearchParams();
        if (selectedGrade) params.set('grade', selectedGrade);
        const status = document.getElementById('status').value;
        if (status) params.set('status', status);
        const q = document.getElementById('q').value.trim();
        if (q) params.set('q', q);

        try {
          const items = await adminFetch('/admin/suggestions' + (params.toString() ? '?' + params.toString() : ''));
          listEl.innerHTML = '';
          if (!items.length) {
            listEl.appendChild(App.el('div', { class: 'rounded-3xl bg-white shadow-md ring-1 ring-slate-200 p-8 text-center' }, [
              App.el('div', { class: 'text-lg font-semibold text-slate-900' }, ['ì¡°ê±´ì— ë§ëŠ” ê±´ì˜ê°€ ì—†ì–´ìš”.']),
              App.el('div', { class: 'text-sm text-slate-600 mt-2' }, ['í•„í„°ë¥¼ ë³€ê²½í•´ ë³´ì„¸ìš”.']),
            ]));
            return;
          }
          items.forEach((s) => listEl.appendChild(itemCard(s)));
        } catch (err) {
          if (err.status === 401) {
            localStorage.removeItem('admin_token');
            location.href = '/admin/login.html';
            return;
          }
          listEl.innerHTML = '';
          listEl.appendChild(App.el('div', { class: 'rounded-3xl bg-white shadow-md ring-1 ring-slate-200 p-6' }, [
            App.el('div', { class: 'text-sm font-semibold text-slate-900' }, ['ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨']),
            App.el('div', { class: 'text-sm text-slate-600 mt-2' }, [err.message || 'API ì˜¤ë¥˜']),
          ]));
        }
      }

      document.getElementById('refreshBtn').addEventListener('click', load);
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('admin_token');
        location.href = '/admin/login.html';
      });

      (async () => {
        try {
          const me = await adminFetch('/admin/me');
          adminMeta.textContent = `ë¡œê·¸ì¸: ${me.username}`;
        } catch {
          localStorage.removeItem('admin_token');
          location.href = '/admin/login.html';
        }
      })();

      renderGradeFilters();
      load();
    </script>
  </body>
</html>
